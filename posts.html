<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENFOCO - Posts</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); color: white; margin: 0; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .topbar { display:flex; justify-content: space-between; align-items:center; padding: 16px 0; }
        .brand { display:flex; align-items:center; gap:10px; color:#4ECDC4; font-weight:700; font-size:20px; }
        .brand .logo { width:32px; height:32px; background: linear-gradient(45deg, #4ECDC4, #44A08D); border-radius:8px; display:flex; align-items:center; justify-content:center; }
        .btn { background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); color:white; border:none; border-radius:10px; padding:10px 16px; cursor:pointer; text-decoration:none; font-weight:600; }
        .btn:disabled { opacity:.6; cursor:not-allowed; }
        .card { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 16px; margin: 16px 0; }
        .new-post { margin-bottom: 24px; display:none; }
        .new-post input, .new-post textarea { width:100%; padding:12px; border-radius:10px; border:2px solid rgba(78,205,196,0.3); background: rgba(255,255,255,0.08); color:white; margin-bottom:10px; font-family: inherit; }
        .new-post textarea { resize: vertical; min-height: 90px; }
        .post { display:flex; gap:16px; }
        .post img { width: 180px; height: 120px; object-fit: cover; border-radius:10px; border:2px solid rgba(78,205,196,0.3); }
        .post-content { flex:1; }
        .meta { color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 6px; }
        /* Hide interactions for viewers: show only posts */
        .actions, .comment-list, .comment-form { display:none !important; }
        /* Modal */
        .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1000; }
        .modal.active { display:flex; }
        .modal-card { background: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.15); padding:16px; border-radius:12px; width:320px; }
        .modal input { width:100%; padding:10px; border-radius:8px; border:2px solid rgba(78,205,196,0.3); background: rgba(255,255,255,0.08); color:white; margin-top:8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="brand"><div class="logo">E</div> ENFOCO Posts</div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="btn" id="adminBtn">Admin</button>
                <a href="/" class="btn">Home</a>
            </div>
        </div>

        <div class="card new-post" id="newPostCard">
            <h3 style="color:#4ECDC4; margin-top:0;">Create a new post</h3>
            <input id="newAuthor" placeholder="Your name (optional)" />
            <input id="newImage" placeholder="Image URL (required)" />
            <textarea id="newDesc" placeholder="Description (required)"></textarea>
            <button class="btn" id="createBtn">Post</button>
            <div id="createMsg" style="margin-top:8px; font-size: 14px;"></div>
        </div>

        <div id="feed"></div>
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-card">
            <h3 style="color:#4ECDC4; margin:0 0 8px;">Admin Login</h3>
            <p style="margin:0 0 8px; color: rgba(255,255,255,0.8);">Enter admin password</p>
            <input id="adminPassword" type="password" placeholder="Password" />
            <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn" id="loginSubmit">Login</button>
                <button class="btn" id="loginCancel" style="background:rgba(255,255,255,0.15);">Cancel</button>
            </div>
            <div id="loginMsg" style="margin-top:8px; font-size: 14px;"></div>
        </div>
    </div>

    <script>
        const API = '/api';
        let admin = false;

        function fmtDate(iso) {
            try { return new Date(iso).toLocaleString(); } catch { return ''; }
        }

        async function fetchPosts() {
            const res = await fetch(`${API}/posts`, { credentials: 'same-origin' });
            const posts = await res.json();
            renderFeed(posts);
        }

        function el(html) {
            const template = document.createElement('template');
            template.innerHTML = html.trim();
            return template.content.firstChild;
        }

        function renderFeed(posts) {
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            if (!posts.length) {
                feed.appendChild(el('<div class="card">No posts yet. Be the first to post!</div>'));
                return;
            }
            posts.forEach(p => {
                const card = el(`<div class="card">
                    <div class="post">
                        <img src="${p.imageUrl}" alt="post image" onerror="this.src='images/lastly.png'" />
                        <div class="post-content">
                            <div style="font-weight:600; margin-bottom:6px;">${escapeHtml(p.description)}</div>
                            <div class="meta">by ${escapeHtml(p.author || 'Anonymous')} â€¢ ${fmtDate(p.createdAt)}</div>
                        </div>
                    </div>
                </div>`);

                feed.appendChild(card);
            });
        }

        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        document.getElementById('createBtn').addEventListener('click', async () => {
            const author = document.getElementById('newAuthor').value.trim();
            const imageUrl = document.getElementById('newImage').value.trim();
            const description = document.getElementById('newDesc').value.trim();
            const msg = document.getElementById('createMsg');
            msg.textContent = '';
            if (!imageUrl || !description) {
                msg.textContent = 'Image URL and Description are required.';
                msg.style.color = '#fca5a5';
                return;
            }
            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.textContent = 'Posting...';
            try {
                const res = await fetch(`${API}/posts`, { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ imageUrl, description, author }) });
                if (res.status === 403) {
                    msg.textContent = 'Admin only. Please login from the Admin button.';
                    msg.style.color = '#fca5a5';
                    return;
                }
                if (!res.ok) throw new Error('Failed');
                document.getElementById('newAuthor').value = '';
                document.getElementById('newImage').value = '';
                document.getElementById('newDesc').value = '';
                msg.textContent = 'Posted!';
                msg.style.color = '#86efac';
                await fetchPosts();
            } catch (e) {
                msg.textContent = 'Could not post right now.';
                msg.style.color = '#fca5a5';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Post';
            }
        });

        // Admin UI
        const adminBtn = document.getElementById('adminBtn');
        const loginModal = document.getElementById('loginModal');
        const loginSubmit = document.getElementById('loginSubmit');
        const loginCancel = document.getElementById('loginCancel');
        const loginMsg = document.getElementById('loginMsg');
        const newPostCard = document.getElementById('newPostCard');

        function setAdminUI(state) {
            admin = !!state;
            newPostCard.style.display = admin ? 'block' : 'none';
            adminBtn.textContent = admin ? 'Logout' : 'Admin';
        }

        async function checkMe() {
            try {
                const res = await fetch(`${API}/admin/me`, { credentials: 'same-origin' });
                const data = await res.json();
                setAdminUI(!!data.isAdmin);
            } catch (_) {
                setAdminUI(false);
            }
        }

        adminBtn.addEventListener('click', async () => {
            if (admin) {
                await fetch(`${API}/admin/logout`, { method: 'POST', credentials: 'same-origin' });
                setAdminUI(false);
                return;
            }
            loginMsg.textContent = '';
            document.getElementById('adminPassword').value = '';
            loginModal.classList.add('active');
        });

        loginCancel.addEventListener('click', () => loginModal.classList.remove('active'));
        loginSubmit.addEventListener('click', async () => {
            loginMsg.textContent = '';
            const password = document.getElementById('adminPassword').value;
            try {
                const res = await fetch(`${API}/admin/login`, { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password }) });
                if (!res.ok) {
                    loginMsg.textContent = 'Invalid password';
                    loginMsg.style.color = '#fca5a5';
                    return;
                }
                loginModal.classList.remove('active');
                await checkMe();
            } catch (e) {
                loginMsg.textContent = 'Login failed';
                loginMsg.style.color = '#fca5a5';
            }
        });

        checkMe();

        fetchPosts();
    </script>
</body>
</html>


